<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RaviSomaTools — Bulk Gene ID Resolver (UniProt / Ensembl / NCBI)</title>
<style>
:root{--bg:#ff4db8;--card:#ff79cd;--panel:#ffe6f5;--black:#000}
body{margin:0;font-family:Inter,Arial,system-ui,sans-serif;background:var(--bg);color:var(--black)}
.wrapper{max-width:1200px;margin:20px auto;padding:12px;display:flex;gap:16px}
.left{width:420px}
.card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.12)}
h1{margin:0 0 10px;font-size:20px}
label{display:block;margin-top:10px;font-weight:600}
textarea,input,select,button{width:100%;box-sizing:border-box;padding:10px;border-radius:6px;border:1px solid #444;font-size:14px}
textarea{min-height:120px;resize:vertical}
.btn{background:#000;color:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
.controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.progress-wrap{margin-top:12px;background:var(--panel);padding:8px;border-radius:8px}
.progress{height:14px;background:#ffdfe9;border-radius:8px;overflow:hidden}
.progress>div{height:100%;background:#000;width:0%}
.table-wrap{flex:1;min-width:500px}
.table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden}
.table th,.table td{padding:8px;border:1px solid #eee;font-size:13px;text-align:left}
.small{font-size:12px;color:#222}
.status-ok{color:green;font-weight:700}
.status-fail{color:#b30000;font-weight:700}
.log{max-height:200px;overflow:auto;margin-top:8px;background:#fff;padding:8px;border-radius:6px}
.note{background:var(--panel);padding:8px;margin-top:10px;border-radius:8px}
.example-controls{display:flex;gap:8px;margin-top:8px}
footer{margin-top:12px;color:#111;font-size:13px}
.badge{display:inline-block;padding:4px 8px;background:#fff;color:#000;border-radius:6px;font-weight:700}
</style>
</head>
<body>
<div class="wrapper">
  <div class="left">
    <div class="card">
      <h1>RaviSomaTools — Bulk Gene ID Resolver</h1>

      <label>Species</label>
      <select id="species">
        <option value="">-- select species --</option>
        <option value="rat">Rattus norvegicus</option>
        <option value="human">Homo sapiens</option>
        <option value="mouse">Mus musculus</option>
      </select>

      <label>Paste gene symbols (one per line)</label>
      <textarea id="genesArea" placeholder="Cyp1a1&#10;Cyp1a2&#10;Cyp2d1"></textarea>
      <small class="small">Or upload CSV with header <code>Gene</code> (first column fallback).</small>

      <label style="margin-top:10px">Upload CSV</label>
      <input id="fileInput" type="file" accept=".csv,.txt"/>

      <div style="margin-top:12px">
        <strong>Examples</strong>
        <div style="margin-top:8px">
          <label class="small">Quick select example set</label>
          <select id="exampleSelect">
            <option value="">-- choose example --</option>
            <option value="rat">Rat: common ADME CYPs</option>
            <option value="mouse">Mouse: common ADME CYPs</option>
            <option value="human">Human: CYP examples</option>
          </select>
          <div style="margin-top:6px">
            <button class="btn" id="useSelectedExample">Use selected example</button>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="startBtn" class="btn">Start Lookup</button>
        <button id="stopBtn" class="btn" style="background:#7a0000">Stop</button>
        <button id="clearCache" class="btn" style="background:#444">Clear cache</button>
      </div>

      <div class="note small">
        <div style="margin-top:6px">
          Prepared by Ravi Adinarayan Somabattini<br>
          Rat: Rattus norvegicus (brown / Norway rat) — common lab species. (Also Rattus rattus is the black rat.)<br>
          Mouse: Mus musculus (house mouse).<br>
          Human: Homo sapiens.
        </div>
      </div>

      <div class="progress-wrap">
        <div id="progressInfo" class="small">Idle</div>
        <div class="progress" style="margin-top:6px"><div id="progressBar"></div></div>
      </div>

      <div style="margin-top:10px" class="small">Organism IDs: Rat (UniProt/TaxID 10116), Human (9606), Mouse (10090)</div>
    </div>
  </div>

  <div class="table-wrap">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Results</strong>
        <div style="display:flex;gap:8px">
          <button id="downloadCSV" class="btn" style="background:#006600">Download CSV</button>
          <button id="downloadXLSX" class="btn" style="background:#004d99">Download XLSX</button>
        </div>
      </div>

      <div style="margin-top:12px;max-height:520px;overflow:auto">
        <table class="table" id="resultTable">
          <thead><tr><th>#</th><th>Gene</th><th>UniProt AC</th><th>Ensembl Gene</th><th>Entrez ID</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>Activity log</strong>
      <div id="log" class="log"></div>
    </div>
  </div>
</div>

<!-- SheetJS for XLSX export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// -------------------- Config and examples --------------------
const EXAMPLES = {
  rat: ["Cyp1a1","Cyp1a2","Cyp2a1","Cyp2b1","Cyp2c6","Cyp2d1","Cyp2e1","Cyp3a1","Cyp3a2","Cyp4a1"],
  mouse: ["Cyp1a1","Cyp2d22","Cyp2e1","Cyp3a11","Cyp2c29","Cyp2b10","Cyp2f2"],
  human: ["CYP1A1","CYP1A2","CYP2D6","CYP2C9","CYP3A4","CYP2E1","CYP2C19"]
};

const ORG = {
  rat: { name: "Rattus norvegicus", uniprotId: 10116, ensemblKey: "rattus_norvegicus", taxid: 10116 },
  human: { name: "Homo sapiens", uniprotId: 9606, ensemblKey: "homo_sapiens", taxid: 9606 },
  mouse: { name: "Mus musculus", uniprotId: 10090, ensemblKey: "mus_musculus", taxid: 10090 }
};

const CONFIG = { delayMs: 300, batchDelayMs: 1000, maxRetries: 3, backoffBase: 700 };
const CACHE_KEY = 'RaviSoma_cache_v4';
let cache = {}; try{ cache = JSON.parse(localStorage.getItem(CACHE_KEY)||'{}'); }catch(e){ cache = {}; }

// -------------------- Helpers --------------------
const $ = id => document.getElementById(id);
const now = ()=>new Date().toISOString().replace('T',' ').replace(/\.\d+Z/,'');
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function log(msg){ const d=document.createElement('div'); d.textContent=`[${now()}] ${msg}`; $('log').prepend(d); }

// -------------------- DOM --------------------
const genesArea = $('genesArea'), fileInput = $('fileInput'), startBtn = $('startBtn'), stopBtn = $('stopBtn');
const clearCacheBtn = $('clearCache'), progressBar = $('progressBar'), progressInfo = $('progressInfo');
const resultTableBody = document.querySelector('#resultTable tbody');
const downloadCSVBtn = $('downloadCSV'), downloadXLSXBtn = $('downloadXLSX');
const speciesEl = $('species'), exampleSelect = $('exampleSelect'), useSelectedExample = $('useSelectedExample');

let STOP_FLAG = false, results = [];

// -------------------- UniProt lookup (improved) --------------------
async function uniProtQuery(gene, uniprotOrgId, queryStr){
  const url = `https://rest.uniprot.org/uniprotkb/search?query=${queryStr}&format=json&fields=primaryAccession`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('UniProt HTTP '+res.status);
  const js = await res.json();
  if(js.results && js.results.length>0) return js.results[0].primaryAccession || "";
  return "";
}

async function uniProtLookup(gene, uniprotOrgId, speciesKey){
  // Try 1: exact gene name query (gene_exact)
  let q1 = `gene_exact:${encodeURIComponent(gene)} AND organism_id:${uniprotOrgId}`;
  try{
    const v1 = await uniProtQuery(gene, uniprotOrgId, q1);
    if(v1) return v1;
  }catch(e){ log(`UniProt try1 error: ${e.message}`); }

  // Try 2: generic gene field (handles casing differences)
  let q2 = `gene:${encodeURIComponent(gene)} AND organism_id:${uniprotOrgId}`;
  try{
    const v2 = await uniProtQuery(gene, uniprotOrgId, q2);
    if(v2) return v2;
  }catch(e){ log(`UniProt try2 error: ${e.message}`); }

  // Try 3: alternate casing strategies
  const altCases = [];
  // If gene looks like camel/lower (rat), try upper-case
  if(/[a-z]/.test(gene) && /[A-Z]/.test(gene)===false) altCases.push(gene.toUpperCase());
  // If gene looks uppercase, try lowercase (rat)
  if(gene===gene.toUpperCase()) altCases.push(gene.toLowerCase());
  for(const alt of altCases){
    try{
      const q = `gene_exact:${encodeURIComponent(alt)} AND organism_id:${uniprotOrgId}`;
      const vv = await uniProtQuery(alt, uniprotOrgId, q);
      if(vv) return vv;
    }catch(e){ /*ignore*/ }
  }

  // No result
  return "";
}

// -------------------- Ensembl & NCBI --------------------
async function ensemblLookup(gene, ensemblSpeciesKey){
  const url = `https://rest.ensembl.org/xrefs/symbol/${ensemblSpeciesKey}/${encodeURIComponent(gene)}?content-type=application/json`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Ensembl HTTP '+res.status);
  const js = await res.json();
  if(js && js.length>0){
    const geneEntry = js.find(x=>x.dbtype==='gene') || js[0];
    return geneEntry.id || "";
  }
  return "";
}

async function ncbiEntrezLookup(gene, taxid){
  const term = encodeURIComponent(`${gene}[Gene Name] AND txid${taxid}[Organism:exp]`);
  const url = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=gene&term=${term}&retmode=json`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('NCBI HTTP '+res.status);
  const js = await res.json();
  if(js.esearchresult && js.esearchresult.idlist && js.esearchresult.idlist.length>0) return js.esearchresult.idlist[0];
  return "";
}

// -------------------- safe wrapper --------------------
async function safeCall(fn, args, label){
  for(let attempt=0; attempt<=CONFIG.maxRetries; attempt++){
    try{
      const v = await fn(...args);
      return {ok:true, value:v};
    }catch(e){
      log(`${label} error: ${e.message} (attempt ${attempt+1})`);
      if(attempt < CONFIG.maxRetries) await sleep(CONFIG.backoffBase * (attempt+1));
      else return {ok:false, error:e.message};
    }
  }
}

// -------------------- UI helpers --------------------
function resetTable(){ results=[]; resultTableBody.innerHTML=''; progressBar.style.width='0%'; progressInfo.textContent='Idle'; }
function addRow(i,gene){ const tr=document.createElement('tr'); tr.id=`row-${i}`; tr.innerHTML=`<td>${i+1}</td><td>${gene}</td><td class="uni">-</td><td class="ens">-</td><td class="ent">-</td><td class="status">Pending</td>`; resultTableBody.appendChild(tr); }
function updateRow(i, uni, ens, ent, status){ const tr=document.getElementById(`row-${i}`); if(!tr) return; tr.querySelector('.uni').textContent = uni||''; tr.querySelector('.ens').textContent = ens||''; tr.querySelector('.ent').textContent = ent||''; const st = tr.querySelector('.status'); st.textContent = status; st.className = 'status ' + (status.toLowerCase().includes('ok') ? 'status-ok' : 'status-fail'); }

// -------------------- Parsers --------------------
function parseGenesFromText(txt){ return txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }
function parseCSVFileContent(text){
  const rows = text.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
  if(rows.length===0) return [];
  const headerCols = rows[0].split(',');
  const headerLower = headerCols.map(c=>c.replace(/["']/g,'').trim().toLowerCase());
  if(headerLower.includes('gene')){ const idx = headerLower.indexOf('gene'); return rows.slice(1).map(r => (r.split(',')[idx]||'').replace(/["']/g,'').trim()).filter(Boolean); }
  return rows.map(r=>r.split(',')[0].replace(/["']/g,'').trim()).filter(Boolean);
}

// -------------------- Bulk processing --------------------
async function processList(geneList, speciesKey){
  STOP_FLAG=false; resetTable();
  const total = geneList.length;
  if(!speciesKey){ alert('Please select a species first'); return; }
  for(let i=0;i<total;i++){
    if(STOP_FLAG){ log('Process stopped by user'); progressInfo.textContent='Stopped'; break; }
    const gene = geneList[i]; addRow(i,gene);
    progressInfo.textContent = `Processing ${i+1}/${total}: ${gene}`; progressBar.style.width = `${Math.round((i/total)*100)}%`;
    const cacheKey = `${gene}||${speciesKey}`;
    if(cache[cacheKey]){ const c = cache[cacheKey]; updateRow(i,c.uni||'',c.ens||'',c.ent||'','OK (cached)'); results.push({Gene:gene,UniProt:c.uni||'',Ensembl:c.ens||'',Entrez:c.ent||'',Status:'OK (cached)'}); log(`Cached: ${gene}`); await sleep(80); continue; }
    const org = ORG[speciesKey];

    // UniProt improved
    const uniRes = await safeCall(uniProtLookup, [gene, org.uniprotId, speciesKey], `UniProt ${gene}`);
    await sleep(CONFIG.delayMs);
    // Ensembl
    const ensRes = await safeCall(ensemblLookup, [gene, org.ensemblKey], `Ensembl ${gene}`);
    await sleep(CONFIG.delayMs);
    // NCBI Entrez
    const entRes = await safeCall(ncbiEntrezLookup, [gene, org.taxid], `Entrez ${gene}`);
    await sleep(CONFIG.delayMs);

    const uniVal = uniRes.ok ? uniRes.value : '';
    const ensVal = ensRes.ok ? ensRes.value : '';
    const entVal = entRes.ok ? entRes.value : '';

    if(uniRes.ok || ensRes.ok || entRes.ok){
      updateRow(i, uniVal||'', ensVal||'', entVal||'', 'OK');
      results.push({Gene:gene,UniProt:uniVal||'',Ensembl:ensVal||'',Entrez:entVal||'',Status:'OK'});
      cache[cacheKey] = {uni:uniVal||'',ens:ensVal||'',ent:entVal||'',ts:Date.now()};
      localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
      log(`Resolved: ${gene} (U:${uniVal||'-'} E:${ensVal||'-'} N:${entVal||'-'})`);
    } else {
      updateRow(i, '', '', '', 'Failed');
      results.push({Gene:gene,UniProt:'',Ensembl:'',Entrez:'',Status:'Failed'});
      log(`Failed: ${gene}`);
    }
    if((i+1)%20===0) await sleep(CONFIG.batchDelayMs);
  }
  progressBar.style.width='100%'; progressInfo.textContent = `Done (${results.length} rows)`; log('Bulk finished');
}

// -------------------- File upload --------------------
fileInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  const text = await f.text(); const genes = parseCSVFileContent(text);
  if(genes.length===0) return alert('No genes found in CSV'); genesArea.value = genes.join('\n'); log(`Loaded ${genes.length} genes from ${f.name}`);
});

// -------------------- Controls --------------------
startBtn.addEventListener('click', async ()=>{
  const txt = genesArea.value.trim(); if(!txt) return alert('Paste gene symbols or upload CSV first');
  const geneList = parseGenesFromText(txt); if(geneList.length===0) return alert('No genes found');
  if(geneList.length>1200 && !confirm(`You are going to lookup ${geneList.length} genes — this may take long and hit rate limits. Continue?`)) return;
  const speciesKey = speciesEl.value; if(!speciesKey) return alert('Please select a species.');
  await processList(geneList, speciesKey);
});
stopBtn.addEventListener('click', ()=>{ STOP_FLAG=true; log('User requested stop'); });
clearCacheBtn.addEventListener('click', ()=>{ if(confirm('Clear the local cache?')){ cache={}; localStorage.removeItem(CACHE_KEY); log('Cache cleared'); }});

// -------------------- Export --------------------
function csvEscape(s){ if(s===null||s===undefined) return ''; return (`${s}`).replace(/"/g,'""'); }
downloadCSVBtn.addEventListener('click', ()=>{
  if(results.length===0) return alert('No results yet'); const header=['Gene','UniProt','Ensembl','Entrez','Status']; const rows = results.map(r=>[r.Gene,r.UniProt,r.Ensembl,r.Entrez,r.Status]); const csv = [header.join(',')].concat(rows.map(r=>r.map(csvEscape).join(','))).join('\n'); const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download=`RaviSomaTools_results_${Date.now()}.csv`; a.click();
});
downloadXLSXBtn.addEventListener('click', ()=>{
  if(results.length===0) return alert('No results yet'); const wb = XLSX.utils.book_new(); const aoa = [['Gene','UniProt','Ensembl','Entrez','Status']].concat(results.map(r=>[r.Gene,r.UniProt,r.Ensembl,r.Entrez,r.Status])); const ws = XLSX.utils.aoa_to_sheet(aoa); XLSX.utils.book_append_sheet(wb, ws, 'results'); const wbout = XLSX.write(wb,{bookType:'xlsx',type:'array'}); const blob = new Blob([wbout], {type:'application/octet-stream'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download=`RaviSomaTools_results_${Date.now()}.xlsx`; a.click(); URL.revokeObjectURL(a.href);
});

// -------------------- Examples UI --------------------
useSelectedExample.addEventListener('click', ()=>{
  const v = exampleSelect.value; if(!v) return alert('Choose an example from the dropdown');
  genesArea.value = EXAMPLES[v].join('\n'); speciesEl.value = v; log(`Loaded ${v} example (dropdown)`);
});

// -------------------- Init --------------------
progressInfo.textContent = 'Ready'; log('RaviSomaTools ready — please select species before Start');
</script>
</body>
</html>
